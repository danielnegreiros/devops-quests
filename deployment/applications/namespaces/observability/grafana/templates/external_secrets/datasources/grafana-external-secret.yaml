apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: grafana-datasource-pg-external-secret
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: cluster-secret-store-vault-cluster
    kind: ClusterSecretStore
  target:
    name: grafana-datasource-pg
    creationPolicy: Owner
    template:
      metadata:
        labels:
          grafana_datasource: 'true'
      data:
        pg-db.yaml: |
          apiVersion: 1
          datasources:
            - name: Kube Bench Postgres
              type: grafana-postgresql-datasource
              url: kube-bench-exporter-postgres.security:5432
              user: {{ `{{ .user }}` }}
              secureJsonData:
                password: {{ `{{ .pass }}` }}
              jsonData:
                database: kubeaudit
                sslmode: 'disable' # disable/require/verify-ca/verify-full
                maxOpenConns: 0 # Grafana v5.4+
                maxIdleConns: 2 # Grafana v5.4+
                connMaxLifetime: 14400 # Grafana v5.4+
                postgresVersion: 1000 # 903=9.3, 904=9.4, 905=9.5, 906=9.6, 1000=10
                timescaledb: false
              editable: false
  data:
    - secretKey: user
      remoteRef:
        key: internal/kube-bench-exporter/postgres/credential
        property: user
    - secretKey: pass
      remoteRef:
        key: internal/kube-bench-exporter/postgres/credential
        property: pass
